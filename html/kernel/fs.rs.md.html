<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.2 — by Tristano Ajmone
==============================================================================
Copyright © Tristano Ajmone, 2017-2020, MIT License (MIT). Project's home:

- https://github.com/tajmone/pandoc-goodies

The CSS in this template reuses source code taken from the following projects:

- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css

- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License

Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.

"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:

(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>fs.rs</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:" "}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
<script data-external="1" async defer src="/home/takashi/cdn/scripts/MathJax-3.2.2/es5/tex-chtml-full.js"></script>
<script data-external="1" async defer src="/home/takashi/cdn/scripts/katex-0.16.7/katex.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<h1 id="kernelfs.rs">kernel/fs.rs</h1>
<div class="sourceCode" id="cb1"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// kernel/fs.rs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::</span>array<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::bio::</span>BCACHE<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::error::</span><span class="op">{</span><span class="bu">Error</span><span class="pp">::</span><span class="op">*,</span> <span class="dt">Result</span><span class="op">};</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::file::</span>Major<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::log::</span>LOG<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::param::</span><span class="op">{</span>NINODE<span class="op">,</span> ROOTDEV<span class="op">};</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::</span><span class="kw">proc</span><span class="pp">::</span><span class="op">{</span>either_copyin<span class="op">,</span> either_copyout<span class="op">,</span> Cpus<span class="op">};</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::sleeplock::</span><span class="op">{</span>SleepLock<span class="op">,</span> SleepLockGuard<span class="op">};</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::spinlock::</span>Mutex<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::stat::</span>FileType<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::stat::</span>Stat<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::</span><span class="op">{</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="pp">sync::</span><span class="op">{</span>LazyLock<span class="op">,</span> OnceLock<span class="op">},</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="pp">vm::</span>VirtAddr<span class="op">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc::sync::</span>Arc<span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">core::mem::</span>size_of<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">core::ops::</span><span class="bu">Deref</span><span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">// File system implementation. Five layers:</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Blocks: allocator for raw disk blocks.</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Log: crash recovery for multi-step updates.</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Files: inode allocator, reading, writing, metadata.</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Directories: inode with special contents (list of other inodes!)</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Names: paths like /octox/src/kernel/fs.rs for convenient naming.</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">// This file contains the low-level file system manipulation</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">// routines. The (higher-level) system call implementations</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">// are in syscall.rs</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> ROOTINO<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// root i-number</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> BSIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// block size</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">// there should be one superblock per disk device, but we run with</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co">// only one device</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">static</span> SB<span class="op">:</span> OnceLock<span class="op">&lt;</span>SuperBlock<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">OnceLock::</span>new()<span class="op">;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Disk layout:</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">// [ root block | super block | log | inode blocks |</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co">//                                          free bit map | data blocks ]</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">// mkfs computes the super block and builds an initial file system. The</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">// super block describes the disk layout:</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="at">)]</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SuperBlock <span class="op">{</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> magic<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>      <span class="co">// Must be FSMAGIC</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> size<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>       <span class="co">// Size of file system image (blocks)</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> nblocks<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>    <span class="co">// Number of data blocks</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> ninodes<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>    <span class="co">// Number of inodes.</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> nlog<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>       <span class="co">// Number of log blocks</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> logstart<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>   <span class="co">// Block number of first log block</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> inodestart<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> <span class="co">// Block number of first inode block</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> bmapstart<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>  <span class="co">// Block number of first free map block</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> FSMAGIC<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">0x10203040</span><span class="op">;</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> NDIRECT<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> NINDIRECT<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> BSIZE <span class="op">/</span> <span class="pp">core::mem::size_of::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> NDINDIRECT<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> NINDIRECT <span class="op">*</span> NINDIRECT<span class="op">;</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> MAXFILE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> NDIRECT <span class="op">+</span> NINDIRECT <span class="op">+</span> NDINDIRECT<span class="op">;</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="co">// On-disk inode structure</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">Default</span><span class="at">)]</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> DInode <span class="op">{</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    itype<span class="op">:</span> FileType<span class="op">,</span>           <span class="co">// File type</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    major<span class="op">:</span> Major<span class="op">,</span>              <span class="co">// Major Device Number (T_DEVICE only)</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    minor<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span>                <span class="co">// Minor Device Number (T_DEVICE only)</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    nlink<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span>                <span class="co">// Number of links to inode in file system</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    size<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>                 <span class="co">// Size of data (bytes)</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    addrs<span class="op">:</span> [<span class="dt">u32</span><span class="op">;</span> NDIRECT <span class="op">+</span> <span class="dv">2</span>]<span class="op">,</span> <span class="co">// Data block address</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Inodes per block</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> IPB<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> BSIZE <span class="op">/</span> <span class="pp">core::mem::size_of::</span><span class="op">&lt;</span>DInode<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Bitmap bits per block</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> BPB<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> (BSIZE <span class="op">*</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co">// Directory is a file containing a sequence of dirent structures.</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">const</span> DIRSIZ<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">14</span><span class="op">;</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">Default</span><span class="at">)]</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> DirEnt <span class="op">{</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> inum<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> DIRSIZ]<span class="op">,</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> SuperBlock <span class="op">{</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> read(dev<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(dev<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>bp<span class="op">.</span><span class="pp">align_to::</span><span class="op">&lt;</span>SuperBlock<span class="op">&gt;</span>()<span class="op">.</span>get(<span class="dv">0</span>)<span class="op">.</span>unwrap()</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Block containing inode i</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> iblock(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> i<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        i <span class="op">/</span> IPB <span class="kw">as</span> <span class="dt">u32</span> <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>inodestart</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Block of free map containing bit for block b</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> bblock(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> b<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        b <span class="op">/</span> BPB <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>bmapstart</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Init fs</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> init(dev<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>    SB<span class="op">.</span>set(<span class="pp">SuperBlock::</span>read(dev))<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert!</span>(sb<span class="op">.</span>magic <span class="op">==</span> FSMAGIC<span class="op">,</span> <span class="st">&quot;invalid file system&quot;</span>)<span class="op">;</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>    LOG<span class="op">.</span>init()<span class="op">;</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co">// Zero a block</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> bzero(dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> bno<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(dev<span class="op">,</span> bno)<span class="op">;</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    bp<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>[<span class="dv">0</span><span class="op">;</span> BSIZE])<span class="op">;</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="co">// Blocks.</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a><span class="co">// Allocate a zeroed disk block.</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> balloc(dev<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> b <span class="kw">in</span> (<span class="dv">0</span><span class="op">..</span>sb<span class="op">.</span>size)<span class="op">.</span>step_by(BPB <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">{</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(dev<span class="op">,</span> sb<span class="op">.</span>bblock(b))<span class="op">;</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bi <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> bi <span class="op">&lt;</span> BPB <span class="op">&amp;&amp;</span> b <span class="op">+</span> bi <span class="op">&lt;</span> sb<span class="op">.</span>size <span class="op">{</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> m <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> (bi <span class="op">%</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bp<span class="op">.</span>get((bi <span class="op">/</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">.</span>unwrap() <span class="op">&amp;</span> m <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Is block free?</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span>bp<span class="op">.</span>get_mut((bi <span class="op">/</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">.</span>unwrap() <span class="op">|=</span> m<span class="op">;</span> <span class="co">// Mark block in use.</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>                LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>                bzero(dev<span class="op">,</span> b <span class="op">+</span> bi)<span class="op">;</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> b <span class="op">+</span> bi<span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>            bi <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>    <span class="pp">unreachable!</span>(<span class="st">&quot;balloc: out of blocks&quot;</span>)<span class="op">;</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a><span class="co">// Free a disk block</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> bfree(dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> b<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(dev<span class="op">,</span> sb<span class="op">.</span>bblock(b))<span class="op">;</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> bi <span class="op">=</span> b <span class="op">%</span> BPB<span class="op">;</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> m <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> (bi <span class="op">%</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bp<span class="op">.</span>get((bi <span class="op">/</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">.</span>unwrap() <span class="op">&amp;</span> m <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>        <span class="pp">panic!</span>(<span class="st">&quot;freeing free block&quot;</span>)<span class="op">;</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>bp<span class="op">.</span>get_mut((bi <span class="op">/</span> <span class="dv">8</span>) <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">.</span>unwrap() <span class="op">&amp;=</span> <span class="op">!</span>m<span class="op">;</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a><span class="co">// Inodes.</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a><span class="co">// An inode describes a single unnamed file.</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a><span class="co">// The inode disk structure holds metadata such as the type of file,</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a><span class="co">// its size, the number of links that reference that file, and a list</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a><span class="co">// of blocks that hold the contents of the file.</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a><span class="co">// The inodes are placed sequentially at sb.startinode on the disk.</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a><span class="co">// Each inode has a number indicating its location on the disk.</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a><span class="co">// The kernel keeps a table of in-use inodes in memory to provide a</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="co">// place to synchronize access to inodes used by multiple processes.</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co">// The in-memory inodes represented Arc&lt;MInode&gt; has book-keeping info</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="co">// that is not stored on disk: atomic ref count and ip.valid.</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a><span class="co">// The inode and its in-memory representation go through the following</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a><span class="co">// sequence of states before being used by the file system code.</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a><span class="co">// * Allocation: alloc() allocates an inode if inode&#39;s type (on disk)</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a><span class="co">//   is non-zero. put() frees if the Arc::strong_count&lt;Arc&lt;MInode&gt;&gt;</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a><span class="co">//   have fallen to 2 and link counts have fallen to zero.</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a><span class="co">// * Referencing in table: an entry in the inode table</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a><span class="co">//   is free if Arc::strong_count(&amp;Arc&lt;MInode&gt;) is 2(what is in the</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a><span class="co">//   table and what is being processed at the time). Otherwise Arc</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a><span class="co">//   count tracks the number of in-memory pointers to the entry (open</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a><span class="co">//   files and current directories). get() finds or creates a table</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a><span class="co">//   entry and increments its Arc count; put() consume Arc&lt;MInode&gt;.</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a><span class="co">// * Valid: the type and size in an inode table entry is only correct</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a><span class="co">//   when ip.valid is true. MInode.lock() reads the inode from the</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a><span class="co">//   disk and sets valid, when put() clears valid if</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a><span class="co">//   Arc::strong_count(&amp;Arc&lt;MInode&gt;) has fallen to 2.</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a><span class="co">// * Locked: file system code may only examine and modify the</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a><span class="co">//   information in an inode and its property if it has first locked</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a><span class="co">//   the inode.</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a><span class="co">// Thus a typical sequence is:</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a><span class="co">//   ip = ITABLE.get(dev, inum);  // get inode</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a><span class="co">//   guard = ip.lock();           // return SleeplockGuard</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a><span class="co">//   .. examine and modify inode contents</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="co">//   // drop(guard)</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a><span class="co">//   // drop(inode)</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a><span class="co">// Because MInode.lock() is separated from ITABLE.get(), system calls</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a><span class="co">// can obtain a long-term reference to the MInode (as for an open file)</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a><span class="co">// and only lock it for a short period of time (e.g., in read()). This</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a><span class="co">// separation also helps avoid deadlocks and races during path-name</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="co">// lookup. ITABLE.get() increments the Arc count, so the inode remains</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="co">// in the table and the pointer to it remains valid.</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a><span class="co">// The ITABLE lock protects the allocation of itable entries. MInode.dev</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a><span class="co">// and Minode.num indicates which i-node an entry holds, one must hold</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a><span class="co">// itable lock while using any of those fields.</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a><span class="co">// An MInode.lock sleeplock protects all ip fields, dev, and inum. One</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a><span class="co">// must hold MInode.lock() in order to read or write that inode&#39;s</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a><span class="co">// ip.valid, ip.size, ip.type.</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">static</span> ITABLE<span class="op">:</span> LazyLock<span class="op">&lt;</span>Mutex<span class="op">&lt;</span>[<span class="dt">Option</span><span class="op">&lt;</span>Arc<span class="op">&lt;</span>MInode<span class="op">&gt;&gt;;</span> NINODE]<span class="op">&gt;&gt;</span> <span class="op">=</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    <span class="pp">LazyLock::</span>new(<span class="op">||</span> <span class="pp">Mutex::</span>new(<span class="pp">array!</span>[<span class="cn">None</span><span class="op">;</span> NINODE]<span class="op">,</span> <span class="st">&quot;itable&quot;</span>))<span class="op">;</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a><span class="co">// Inode passed from ITABLE.</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a><span class="co">// Wrapper for in-memory inode i.e. MInode</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Default</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Inode <span class="op">{</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    ip<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>Arc<span class="op">&lt;</span>MInode<span class="op">&gt;&gt;,</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a><span class="co">// in-memory copy of an inode</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MInode <span class="op">{</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>    dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>    inum<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>    data<span class="op">:</span> SleepLock<span class="op">&lt;</span>IData<span class="op">&gt;,</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Default</span><span class="at">)]</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> IData <span class="op">{</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>    dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>    inum<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    valid<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>    itype<span class="op">:</span> FileType<span class="op">,</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    major<span class="op">:</span> Major<span class="op">,</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>    minor<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    nlink<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    size<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>    addrs<span class="op">:</span> [<span class="dt">u32</span><span class="op">;</span> NDIRECT <span class="op">+</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> LinkOp <span class="op">{</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>    Plus<span class="op">,</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>    Minus<span class="op">,</span></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>    Init(<span class="dt">u16</span>)<span class="op">,</span></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> IData <span class="op">{</span></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> new(dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> inum<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>            dev<span class="op">,</span></span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>            inum<span class="op">,</span></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>            <span class="op">..</span><span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> size(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>size</span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> itype(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> FileType <span class="op">{</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>itype</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> major(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Major <span class="op">{</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>major</span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>    <span class="co">// inode is write through, so change about MInode is also must be written into disk</span></span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_type(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> itype<span class="op">:</span> FileType) <span class="op">{</span></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>itype <span class="op">=</span> itype<span class="op">;</span></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>    <span class="co">// inode is write through, so change about MInode is also must be written into disk</span></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_major_minor(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> major<span class="op">:</span> Major<span class="op">,</span> minor<span class="op">:</span> <span class="dt">u16</span>) <span class="op">{</span></span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>major <span class="op">=</span> major<span class="op">;</span></span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>minor <span class="op">=</span> minor<span class="op">;</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>    <span class="co">// inode is write through, so change about MInode is also must be written into disk</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_size(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> size<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>size <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>    <span class="co">// inode is write through, so change about MInode is also must be written into disk</span></span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_addrs(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> bn<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span> addr<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>addrs[bn] <span class="op">=</span> addr<span class="op">;</span></span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>    <span class="co">// inode is write through, so change about MInode is also must be written into disk.</span></span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_nlink(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> op<span class="op">:</span> LinkOp) <span class="op">{</span></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> op <span class="op">{</span></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>            <span class="pp">LinkOp::</span>Plus <span class="op">=&gt;</span> <span class="kw">self</span><span class="op">.</span>nlink <span class="op">+=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>            <span class="pp">LinkOp::</span>Minus <span class="op">=&gt;</span> <span class="kw">self</span><span class="op">.</span>nlink <span class="op">-=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>            <span class="pp">LinkOp::</span>Init(num) <span class="op">=&gt;</span> <span class="kw">self</span><span class="op">.</span>nlink <span class="op">=</span> num<span class="op">,</span></span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy a modified in-memory inode to disk.</span></span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Must be called after every change to an inode field</span></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>    <span class="co">// that lives on disk.</span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Caller must hold inode sleeplock.</span></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> update(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> sb<span class="op">.</span>iblock(<span class="kw">self</span><span class="op">.</span>inum))<span class="op">;</span></span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> dip <span class="op">=</span> bp</span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="pp">align_to_mut::</span><span class="op">&lt;</span>DInode<span class="op">&gt;</span>()</span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>get_mut(<span class="kw">self</span><span class="op">.</span>inum <span class="kw">as</span> <span class="dt">usize</span> <span class="op">%</span> IPB)</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>itype <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>itype<span class="op">;</span></span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>major <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>major<span class="op">;</span></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>minor <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>minor<span class="op">;</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>nlink <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>nlink<span class="op">;</span></span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>size <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>size<span class="op">;</span></span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>        dip<span class="op">.</span>addrs<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>addrs)<span class="op">;</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>        LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Truncate inode (discard contents).</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Caller must hold inode sleeplock.</span></span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> trunc(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> addr <span class="kw">in</span> <span class="kw">self</span><span class="op">.</span>addrs<span class="op">.</span>iter_mut()<span class="op">.</span>take(NDIRECT) <span class="op">{</span></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">*</span>addr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>                bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="op">*</span>addr)<span class="op">;</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span>addr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> naddr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>addrs<span class="op">.</span>get_mut(NDIRECT)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">*</span>naddr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="op">*</span>naddr)<span class="op">;</span></span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> bp<span class="op">.</span><span class="pp">align_to::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">&amp;</span>addr <span class="kw">in</span> a<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 0 .. NINDIRECT = BISIZE / u32</span></span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> addr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a>                    bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a>            drop(bp)<span class="op">;</span></span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a>            bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="op">*</span>naddr)<span class="op">;</span></span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>naddr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ndaddr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>addrs<span class="op">.</span>get_mut(NDIRECT <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">*</span>ndaddr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="op">*</span>ndaddr)<span class="op">;</span></span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> bp<span class="op">.</span><span class="pp">align_to::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">&amp;</span>a_addr <span class="kw">in</span> a<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> a_addr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> cp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> a_addr)<span class="op">;</span></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> b <span class="op">=</span> cp<span class="op">.</span><span class="pp">align_to::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">&amp;</span>b_addr <span class="kw">in</span> b<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb1-395"><a href="#cb1-395" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> b_addr <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-396"><a href="#cb1-396" aria-hidden="true" tabindex="-1"></a>                            bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> b_addr)<span class="op">;</span></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb1-398"><a href="#cb1-398" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb1-399"><a href="#cb1-399" aria-hidden="true" tabindex="-1"></a>                    drop(cp)<span class="op">;</span></span>
<span id="cb1-400"><a href="#cb1-400" aria-hidden="true" tabindex="-1"></a>                    bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> a_addr)<span class="op">;</span></span>
<span id="cb1-401"><a href="#cb1-401" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-402"><a href="#cb1-402" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-403"><a href="#cb1-403" aria-hidden="true" tabindex="-1"></a>            drop(bp)<span class="op">;</span></span>
<span id="cb1-404"><a href="#cb1-404" aria-hidden="true" tabindex="-1"></a>            bfree(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="op">*</span>ndaddr)<span class="op">;</span></span>
<span id="cb1-405"><a href="#cb1-405" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>ndaddr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-406"><a href="#cb1-406" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-407"><a href="#cb1-407" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-408"><a href="#cb1-408" aria-hidden="true" tabindex="-1"></a>        <span class="co">// update is needed, because size and addrs are updated.</span></span>
<span id="cb1-409"><a href="#cb1-409" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-410"><a href="#cb1-410" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-411"><a href="#cb1-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-412"><a href="#cb1-412" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inode content</span></span>
<span id="cb1-413"><a href="#cb1-413" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb1-414"><a href="#cb1-414" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The content (data) associated with each inode is stored</span></span>
<span id="cb1-415"><a href="#cb1-415" aria-hidden="true" tabindex="-1"></a>    <span class="co">// in blocks on the disk. The first NDIRECT block numbers</span></span>
<span id="cb1-416"><a href="#cb1-416" aria-hidden="true" tabindex="-1"></a>    <span class="co">// are listed in idata.addrs[]. The next NINDIRECT blocks</span></span>
<span id="cb1-417"><a href="#cb1-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">// are listed in block idata.addrs[NDIRECT].</span></span>
<span id="cb1-418"><a href="#cb1-418" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The next NDINDIRECT blocks are listed in block</span></span>
<span id="cb1-419"><a href="#cb1-419" aria-hidden="true" tabindex="-1"></a>    <span class="co">// idata.addrs[NDIRECT + 1].</span></span>
<span id="cb1-420"><a href="#cb1-420" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb1-421"><a href="#cb1-421" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return the disk block address of the nth block in inode ip.</span></span>
<span id="cb1-422"><a href="#cb1-422" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If there is no such block, bmap allocates one.</span></span>
<span id="cb1-423"><a href="#cb1-423" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> bmap(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> bn<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> alloc<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-424"><a href="#cb1-424" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> addr<span class="op">;</span></span>
<span id="cb1-425"><a href="#cb1-425" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bn <span class="op">=</span> bn <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb1-426"><a href="#cb1-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-427"><a href="#cb1-427" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bn <span class="op">&lt;</span> NDIRECT <span class="op">{</span></span>
<span id="cb1-428"><a href="#cb1-428" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>addrs[bn]<span class="op">;</span></span>
<span id="cb1-429"><a href="#cb1-429" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-430"><a href="#cb1-430" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-431"><a href="#cb1-431" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>set_addrs(bn<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-432"><a href="#cb1-432" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-433"><a href="#cb1-433" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(addr)<span class="op">;</span></span>
<span id="cb1-434"><a href="#cb1-434" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-435"><a href="#cb1-435" aria-hidden="true" tabindex="-1"></a>        bn <span class="op">-=</span> NDIRECT<span class="op">;</span></span>
<span id="cb1-436"><a href="#cb1-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-437"><a href="#cb1-437" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bn <span class="op">&lt;</span> NINDIRECT <span class="op">{</span></span>
<span id="cb1-438"><a href="#cb1-438" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Load indirect block, allocating if necessary.</span></span>
<span id="cb1-439"><a href="#cb1-439" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>addrs[NDIRECT]<span class="op">;</span></span>
<span id="cb1-440"><a href="#cb1-440" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-441"><a href="#cb1-441" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-442"><a href="#cb1-442" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>set_addrs(NDIRECT<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-443"><a href="#cb1-443" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-444"><a href="#cb1-444" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-445"><a href="#cb1-445" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> bp<span class="op">.</span><span class="pp">align_to_mut::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-446"><a href="#cb1-446" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> a[bn]<span class="op">;</span></span>
<span id="cb1-447"><a href="#cb1-447" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-448"><a href="#cb1-448" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-449"><a href="#cb1-449" aria-hidden="true" tabindex="-1"></a>                a[bn] <span class="op">=</span> addr<span class="op">;</span></span>
<span id="cb1-450"><a href="#cb1-450" aria-hidden="true" tabindex="-1"></a>                LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-451"><a href="#cb1-451" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-452"><a href="#cb1-452" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(addr)<span class="op">;</span></span>
<span id="cb1-453"><a href="#cb1-453" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-454"><a href="#cb1-454" aria-hidden="true" tabindex="-1"></a>        bn <span class="op">-=</span> NINDIRECT<span class="op">;</span></span>
<span id="cb1-455"><a href="#cb1-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-456"><a href="#cb1-456" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bn <span class="op">&lt;</span> NDINDIRECT <span class="op">{</span></span>
<span id="cb1-457"><a href="#cb1-457" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Load double indirect block, allocating if necessary.</span></span>
<span id="cb1-458"><a href="#cb1-458" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>addrs[NDIRECT <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb1-459"><a href="#cb1-459" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-460"><a href="#cb1-460" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-461"><a href="#cb1-461" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>set_addrs(NDIRECT <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-462"><a href="#cb1-462" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-463"><a href="#cb1-463" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Load 2nd layer block.</span></span>
<span id="cb1-464"><a href="#cb1-464" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb1-465"><a href="#cb1-465" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-466"><a href="#cb1-466" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> a <span class="op">=</span> bp<span class="op">.</span><span class="pp">align_to_mut::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-467"><a href="#cb1-467" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> dbn <span class="op">=</span> bn <span class="op">/</span> NINDIRECT<span class="op">;</span></span>
<span id="cb1-468"><a href="#cb1-468" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> a[dbn]<span class="op">;</span></span>
<span id="cb1-469"><a href="#cb1-469" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-470"><a href="#cb1-470" aria-hidden="true" tabindex="-1"></a>                    addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-471"><a href="#cb1-471" aria-hidden="true" tabindex="-1"></a>                    a[dbn] <span class="op">=</span> addr<span class="op">;</span></span>
<span id="cb1-472"><a href="#cb1-472" aria-hidden="true" tabindex="-1"></a>                    LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-473"><a href="#cb1-473" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-474"><a href="#cb1-474" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-475"><a href="#cb1-475" aria-hidden="true" tabindex="-1"></a>            <span class="co">// now find disk block</span></span>
<span id="cb1-476"><a href="#cb1-476" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> addr)<span class="op">;</span></span>
<span id="cb1-477"><a href="#cb1-477" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> bp<span class="op">.</span><span class="pp">align_to_mut::</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb1-478"><a href="#cb1-478" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bn <span class="op">=</span> bn <span class="op">%</span> NINDIRECT<span class="op">;</span></span>
<span id="cb1-479"><a href="#cb1-479" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> a[bn]<span class="op">;</span></span>
<span id="cb1-480"><a href="#cb1-480" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> alloc <span class="op">{</span></span>
<span id="cb1-481"><a href="#cb1-481" aria-hidden="true" tabindex="-1"></a>                addr <span class="op">=</span> balloc(<span class="kw">self</span><span class="op">.</span>dev)<span class="op">;</span></span>
<span id="cb1-482"><a href="#cb1-482" aria-hidden="true" tabindex="-1"></a>                a[bn] <span class="op">=</span> addr<span class="op">;</span></span>
<span id="cb1-483"><a href="#cb1-483" aria-hidden="true" tabindex="-1"></a>                LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-484"><a href="#cb1-484" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-485"><a href="#cb1-485" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(addr)<span class="op">;</span></span>
<span id="cb1-486"><a href="#cb1-486" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-487"><a href="#cb1-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-488"><a href="#cb1-488" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(StorageFull)</span>
<span id="cb1-489"><a href="#cb1-489" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-490"><a href="#cb1-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-491"><a href="#cb1-491" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy stat information from inode.</span></span>
<span id="cb1-492"><a href="#cb1-492" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Caller must hold sleeplock</span></span>
<span id="cb1-493"><a href="#cb1-493" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> stat(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> st<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Stat) <span class="op">{</span></span>
<span id="cb1-494"><a href="#cb1-494" aria-hidden="true" tabindex="-1"></a>        st<span class="op">.</span>dev <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>dev<span class="op">;</span></span>
<span id="cb1-495"><a href="#cb1-495" aria-hidden="true" tabindex="-1"></a>        st<span class="op">.</span>ino <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>inum<span class="op">;</span></span>
<span id="cb1-496"><a href="#cb1-496" aria-hidden="true" tabindex="-1"></a>        st<span class="op">.</span>ftype <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>itype<span class="op">;</span></span>
<span id="cb1-497"><a href="#cb1-497" aria-hidden="true" tabindex="-1"></a>        st<span class="op">.</span>nlink <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>nlink<span class="op">;</span></span>
<span id="cb1-498"><a href="#cb1-498" aria-hidden="true" tabindex="-1"></a>        st<span class="op">.</span>size <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb1-499"><a href="#cb1-499" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-500"><a href="#cb1-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-501"><a href="#cb1-501" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read data from inode.</span></span>
<span id="cb1-502"><a href="#cb1-502" aria-hidden="true" tabindex="-1"></a>    <span class="co">// dst is UVAddr or KVAddr</span></span>
<span id="cb1-503"><a href="#cb1-503" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> read(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> <span class="kw">mut</span> dst<span class="op">:</span> VirtAddr<span class="op">,</span> off<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> <span class="kw">mut</span> n<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-504"><a href="#cb1-504" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-505"><a href="#cb1-505" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> off <span class="op">=</span> off <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb1-506"><a href="#cb1-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-507"><a href="#cb1-507" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> off <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></span>
<span id="cb1-508"><a href="#cb1-508" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-509"><a href="#cb1-509" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-510"><a href="#cb1-510" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> off <span class="op">+</span> n <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></span>
<span id="cb1-511"><a href="#cb1-511" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span> <span class="op">-</span> off<span class="op">;</span></span>
<span id="cb1-512"><a href="#cb1-512" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-513"><a href="#cb1-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-514"><a href="#cb1-514" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> tot <span class="op">&lt;</span> n <span class="op">{</span></span>
<span id="cb1-515"><a href="#cb1-515" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>bmap((off <span class="op">/</span> BSIZE) <span class="kw">as</span> <span class="dt">u32</span><span class="op">,</span> <span class="cn">false</span>)<span class="op">?</span>)<span class="op">;</span></span>
<span id="cb1-516"><a href="#cb1-516" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> m <span class="op">=</span> <span class="pp">core::cmp::</span>min(n <span class="op">-</span> tot<span class="op">,</span> BSIZE <span class="op">-</span> off <span class="op">%</span> BSIZE)<span class="op">;</span></span>
<span id="cb1-517"><a href="#cb1-517" aria-hidden="true" tabindex="-1"></a>            either_copyout(dst<span class="op">,</span> <span class="op">&amp;</span>bp[(off <span class="op">%</span> BSIZE)<span class="op">..</span>(off <span class="op">%</span> BSIZE <span class="op">+</span> m)])<span class="op">?;</span></span>
<span id="cb1-518"><a href="#cb1-518" aria-hidden="true" tabindex="-1"></a>            tot <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-519"><a href="#cb1-519" aria-hidden="true" tabindex="-1"></a>            off <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-520"><a href="#cb1-520" aria-hidden="true" tabindex="-1"></a>            dst <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-521"><a href="#cb1-521" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-522"><a href="#cb1-522" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(tot)</span>
<span id="cb1-523"><a href="#cb1-523" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-524"><a href="#cb1-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-525"><a href="#cb1-525" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write data to inode.</span></span>
<span id="cb1-526"><a href="#cb1-526" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Caller must hold sleeplock.</span></span>
<span id="cb1-527"><a href="#cb1-527" aria-hidden="true" tabindex="-1"></a>    <span class="co">// dst is UVAddr or KVAddr</span></span>
<span id="cb1-528"><a href="#cb1-528" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Returns the number of bytes successfully written.</span></span>
<span id="cb1-529"><a href="#cb1-529" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If the return value is less then the requested n,</span></span>
<span id="cb1-530"><a href="#cb1-530" aria-hidden="true" tabindex="-1"></a>    <span class="co">// there was an error of some kind.</span></span>
<span id="cb1-531"><a href="#cb1-531" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> write(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> <span class="kw">mut</span> src<span class="op">:</span> VirtAddr<span class="op">,</span> off<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> n<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-532"><a href="#cb1-532" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-533"><a href="#cb1-533" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> off <span class="op">=</span> off <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb1-534"><a href="#cb1-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-535"><a href="#cb1-535" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> off <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span> <span class="op">||</span> off <span class="op">+</span> n <span class="op">&gt;</span> MAXFILE <span class="op">*</span> BSIZE <span class="op">{</span></span>
<span id="cb1-536"><a href="#cb1-536" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(FileTooLarge)<span class="op">;</span></span>
<span id="cb1-537"><a href="#cb1-537" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-538"><a href="#cb1-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-539"><a href="#cb1-539" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> tot <span class="op">&lt;</span> n <span class="op">{</span></span>
<span id="cb1-540"><a href="#cb1-540" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>bmap((off <span class="op">/</span> BSIZE) <span class="kw">as</span> <span class="dt">u32</span><span class="op">,</span> <span class="cn">true</span>)<span class="op">?</span>)<span class="op">;</span></span>
<span id="cb1-541"><a href="#cb1-541" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> m <span class="op">=</span> <span class="pp">core::cmp::</span>min(n <span class="op">-</span> tot<span class="op">,</span> BSIZE <span class="op">-</span> off <span class="op">%</span> BSIZE)<span class="op">;</span></span>
<span id="cb1-542"><a href="#cb1-542" aria-hidden="true" tabindex="-1"></a>            either_copyin(<span class="op">&amp;</span><span class="kw">mut</span> bp[(off <span class="op">%</span> BSIZE)<span class="op">..</span>(off <span class="op">%</span> BSIZE <span class="op">+</span> m)]<span class="op">,</span> src)<span class="op">?;</span></span>
<span id="cb1-543"><a href="#cb1-543" aria-hidden="true" tabindex="-1"></a>            tot <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-544"><a href="#cb1-544" aria-hidden="true" tabindex="-1"></a>            off <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-545"><a href="#cb1-545" aria-hidden="true" tabindex="-1"></a>            src <span class="op">+=</span> m<span class="op">;</span></span>
<span id="cb1-546"><a href="#cb1-546" aria-hidden="true" tabindex="-1"></a>            LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-547"><a href="#cb1-547" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-548"><a href="#cb1-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-549"><a href="#cb1-549" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> off <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></span>
<span id="cb1-550"><a href="#cb1-550" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>set_size(off <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb1-551"><a href="#cb1-551" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-552"><a href="#cb1-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-553"><a href="#cb1-553" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(tot)</span>
<span id="cb1-554"><a href="#cb1-554" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-555"><a href="#cb1-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-556"><a href="#cb1-556" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Directories</span></span>
<span id="cb1-557"><a href="#cb1-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-558"><a href="#cb1-558" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Look for a directory entry in a directory.</span></span>
<span id="cb1-559"><a href="#cb1-559" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If found, set *poff to byte offset of entry.</span></span>
<span id="cb1-560"><a href="#cb1-560" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> dirlookup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> poff<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;&amp;</span><span class="kw">mut</span> <span class="dt">u32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Inode<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-561"><a href="#cb1-561" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> de<span class="op">:</span> DirEnt <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb1-562"><a href="#cb1-562" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>itype <span class="op">!=</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-563"><a href="#cb1-563" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(NotADirectory)<span class="op">;</span></span>
<span id="cb1-564"><a href="#cb1-564" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-565"><a href="#cb1-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-566"><a href="#cb1-566" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> off <span class="kw">in</span> (<span class="dv">0</span><span class="op">..</span><span class="kw">self</span><span class="op">.</span>size)<span class="op">.</span>step_by(<span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()) <span class="op">{</span></span>
<span id="cb1-567"><a href="#cb1-567" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>read(</span>
<span id="cb1-568"><a href="#cb1-568" aria-hidden="true" tabindex="-1"></a>                <span class="pp">VirtAddr::</span>Kernel(<span class="op">&amp;</span><span class="kw">mut</span> de <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> _ <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">,</span></span>
<span id="cb1-569"><a href="#cb1-569" aria-hidden="true" tabindex="-1"></a>                off<span class="op">,</span></span>
<span id="cb1-570"><a href="#cb1-570" aria-hidden="true" tabindex="-1"></a>                <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb1-571"><a href="#cb1-571" aria-hidden="true" tabindex="-1"></a>            )<span class="op">?;</span></span>
<span id="cb1-572"><a href="#cb1-572" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> de<span class="op">.</span>inum <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-573"><a href="#cb1-573" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb1-574"><a href="#cb1-574" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-575"><a href="#cb1-575" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name</span>
<span id="cb1-576"><a href="#cb1-576" aria-hidden="true" tabindex="-1"></a>                <span class="op">==</span> <span class="pp">core::</span><span class="dt">str</span><span class="pp">::</span>from_utf8(<span class="op">&amp;</span>de<span class="op">.</span>name)</span>
<span id="cb1-577"><a href="#cb1-577" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>unwrap()</span>
<span id="cb1-578"><a href="#cb1-578" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>trim_matches(<span class="dt">char</span><span class="pp">::</span>from(<span class="dv">0</span>))</span>
<span id="cb1-579"><a href="#cb1-579" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb1-580"><a href="#cb1-580" aria-hidden="true" tabindex="-1"></a>                <span class="co">// entry matches path element</span></span>
<span id="cb1-581"><a href="#cb1-581" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(poff) <span class="op">=</span> poff <span class="op">{</span></span>
<span id="cb1-582"><a href="#cb1-582" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span>poff <span class="op">=</span> off<span class="op">;</span></span>
<span id="cb1-583"><a href="#cb1-583" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-584"><a href="#cb1-584" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> ITABLE<span class="op">.</span>get(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> de<span class="op">.</span>inum <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb1-585"><a href="#cb1-585" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-586"><a href="#cb1-586" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-587"><a href="#cb1-587" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(NotFound)</span>
<span id="cb1-588"><a href="#cb1-588" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-589"><a href="#cb1-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-590"><a href="#cb1-590" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write a new directory entry (name, inum) into the directory dp.</span></span>
<span id="cb1-591"><a href="#cb1-591" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> dirlink(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> inum<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-592"><a href="#cb1-592" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> de<span class="op">:</span> DirEnt <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb1-593"><a href="#cb1-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-594"><a href="#cb1-594" aria-hidden="true" tabindex="-1"></a>        <span class="co">// check that name is not present.</span></span>
<span id="cb1-595"><a href="#cb1-595" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>dirlookup(name<span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span>map_or_else(</span>
<span id="cb1-596"><a href="#cb1-596" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span>err<span class="op">|</span> <span class="cf">if</span> err <span class="op">==</span> NotFound <span class="op">{</span> <span class="cn">Ok</span>(()) <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="cn">Err</span>(err) <span class="op">},</span></span>
<span id="cb1-597"><a href="#cb1-597" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span>_<span class="op">|</span> <span class="cn">Err</span>(AlreadyExists)<span class="op">,</span></span>
<span id="cb1-598"><a href="#cb1-598" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb1-599"><a href="#cb1-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-600"><a href="#cb1-600" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Look for an empty dirent</span></span>
<span id="cb1-601"><a href="#cb1-601" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> off <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-602"><a href="#cb1-602" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> off <span class="op">&lt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="op">{</span></span>
<span id="cb1-603"><a href="#cb1-603" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>read(</span>
<span id="cb1-604"><a href="#cb1-604" aria-hidden="true" tabindex="-1"></a>                <span class="pp">VirtAddr::</span>Kernel(<span class="op">&amp;</span><span class="kw">mut</span> de <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> _ <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">,</span></span>
<span id="cb1-605"><a href="#cb1-605" aria-hidden="true" tabindex="-1"></a>                off<span class="op">,</span></span>
<span id="cb1-606"><a href="#cb1-606" aria-hidden="true" tabindex="-1"></a>                <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb1-607"><a href="#cb1-607" aria-hidden="true" tabindex="-1"></a>            )<span class="op">?;</span></span>
<span id="cb1-608"><a href="#cb1-608" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> de<span class="op">.</span>inum <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-609"><a href="#cb1-609" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-610"><a href="#cb1-610" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-611"><a href="#cb1-611" aria-hidden="true" tabindex="-1"></a>            off <span class="op">+=</span> <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>() <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb1-612"><a href="#cb1-612" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-613"><a href="#cb1-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-614"><a href="#cb1-614" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> len <span class="op">=</span> <span class="pp">core::cmp::</span>min(name<span class="op">.</span>len()<span class="op">,</span> DIRSIZ)<span class="op">;</span></span>
<span id="cb1-615"><a href="#cb1-615" aria-hidden="true" tabindex="-1"></a>        de<span class="op">.</span>name<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>[<span class="dv">0</span><span class="op">;</span> DIRSIZ])<span class="op">;</span></span>
<span id="cb1-616"><a href="#cb1-616" aria-hidden="true" tabindex="-1"></a>        de<span class="op">.</span>name[<span class="dv">0</span><span class="op">..</span>len]<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>name<span class="op">.</span>as_bytes()[<span class="dv">0</span><span class="op">..</span>len])<span class="op">;</span></span>
<span id="cb1-617"><a href="#cb1-617" aria-hidden="true" tabindex="-1"></a>        de<span class="op">.</span>inum <span class="op">=</span> inum <span class="kw">as</span> <span class="dt">u16</span><span class="op">;</span></span>
<span id="cb1-618"><a href="#cb1-618" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>write(</span>
<span id="cb1-619"><a href="#cb1-619" aria-hidden="true" tabindex="-1"></a>            <span class="pp">VirtAddr::</span>Kernel(<span class="op">&amp;</span><span class="kw">mut</span> de <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> _ <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">,</span></span>
<span id="cb1-620"><a href="#cb1-620" aria-hidden="true" tabindex="-1"></a>            off<span class="op">,</span></span>
<span id="cb1-621"><a href="#cb1-621" aria-hidden="true" tabindex="-1"></a>            <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb1-622"><a href="#cb1-622" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb1-623"><a href="#cb1-623" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb1-624"><a href="#cb1-624" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-625"><a href="#cb1-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-626"><a href="#cb1-626" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Is the directory dp empty except for &quot;.&quot; and &quot;..&quot; ?</span></span>
<span id="cb1-627"><a href="#cb1-627" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> is_dir_empty(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-628"><a href="#cb1-628" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> de<span class="op">:</span> DirEnt <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb1-629"><a href="#cb1-629" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> off <span class="kw">in</span> ((<span class="dv">2</span> <span class="op">*</span> <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>() <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">..</span><span class="kw">self</span><span class="op">.</span>size)<span class="op">.</span>step_by(<span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()) <span class="op">{</span></span>
<span id="cb1-630"><a href="#cb1-630" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span></span>
<span id="cb1-631"><a href="#cb1-631" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>read(</span>
<span id="cb1-632"><a href="#cb1-632" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">VirtAddr::</span>Kernel(<span class="op">&amp;</span><span class="kw">mut</span> de <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> _ <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">,</span></span>
<span id="cb1-633"><a href="#cb1-633" aria-hidden="true" tabindex="-1"></a>                    off<span class="op">,</span></span>
<span id="cb1-634"><a href="#cb1-634" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb1-635"><a href="#cb1-635" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb1-636"><a href="#cb1-636" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>is_err()</span>
<span id="cb1-637"><a href="#cb1-637" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb1-638"><a href="#cb1-638" aria-hidden="true" tabindex="-1"></a>                <span class="pp">panic!</span>(<span class="st">&quot;isdirempty: inode read&quot;</span>)<span class="op">;</span></span>
<span id="cb1-639"><a href="#cb1-639" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-640"><a href="#cb1-640" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> de<span class="op">.</span>inum <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-641"><a href="#cb1-641" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb1-642"><a href="#cb1-642" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-643"><a href="#cb1-643" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-644"><a href="#cb1-644" aria-hidden="true" tabindex="-1"></a>        <span class="cn">true</span></span>
<span id="cb1-645"><a href="#cb1-645" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-646"><a href="#cb1-646" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-647"><a href="#cb1-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-648"><a href="#cb1-648" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-649"><a href="#cb1-649" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> MInode <span class="op">{</span></span>
<span id="cb1-650"><a href="#cb1-650" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> new(dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> inum<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-651"><a href="#cb1-651" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-652"><a href="#cb1-652" aria-hidden="true" tabindex="-1"></a>            dev<span class="op">,</span></span>
<span id="cb1-653"><a href="#cb1-653" aria-hidden="true" tabindex="-1"></a>            inum<span class="op">,</span></span>
<span id="cb1-654"><a href="#cb1-654" aria-hidden="true" tabindex="-1"></a>            data<span class="op">:</span> <span class="pp">SleepLock::</span>new(<span class="pp">IData::</span>new(dev<span class="op">,</span> inum)<span class="op">,</span> <span class="st">&quot;inode&quot;</span>)<span class="op">,</span></span>
<span id="cb1-655"><a href="#cb1-655" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-656"><a href="#cb1-656" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-657"><a href="#cb1-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-658"><a href="#cb1-658" aria-hidden="true" tabindex="-1"></a>    <span class="co">// unlock function is no need.</span></span>
<span id="cb1-659"><a href="#cb1-659" aria-hidden="true" tabindex="-1"></a>    <span class="co">// because SleepLockGuard impl Drop trait.</span></span>
<span id="cb1-660"><a href="#cb1-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-661"><a href="#cb1-661" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lock the inode</span></span>
<span id="cb1-662"><a href="#cb1-662" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reads the inode from disk if necessary.</span></span>
<span id="cb1-663"><a href="#cb1-663" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> lock(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> SleepLockGuard<span class="op">&lt;</span>IData<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-664"><a href="#cb1-664" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-665"><a href="#cb1-665" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> guard <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>data<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-666"><a href="#cb1-666" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>guard<span class="op">.</span>valid <span class="op">{</span></span>
<span id="cb1-667"><a href="#cb1-667" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(<span class="kw">self</span><span class="op">.</span>dev<span class="op">,</span> sb<span class="op">.</span>iblock(<span class="kw">self</span><span class="op">.</span>inum))<span class="op">;</span></span>
<span id="cb1-668"><a href="#cb1-668" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> dip <span class="op">=</span> bp</span>
<span id="cb1-669"><a href="#cb1-669" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">align_to::</span><span class="op">&lt;</span>DInode<span class="op">&gt;</span>()</span>
<span id="cb1-670"><a href="#cb1-670" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>get(<span class="kw">self</span><span class="op">.</span>inum <span class="kw">as</span> <span class="dt">usize</span> <span class="op">%</span> IPB)</span>
<span id="cb1-671"><a href="#cb1-671" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-672"><a href="#cb1-672" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>itype <span class="op">=</span> dip<span class="op">.</span>itype<span class="op">;</span></span>
<span id="cb1-673"><a href="#cb1-673" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>major <span class="op">=</span> dip<span class="op">.</span>major<span class="op">;</span></span>
<span id="cb1-674"><a href="#cb1-674" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>minor <span class="op">=</span> dip<span class="op">.</span>minor<span class="op">;</span></span>
<span id="cb1-675"><a href="#cb1-675" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>nlink <span class="op">=</span> dip<span class="op">.</span>nlink<span class="op">;</span></span>
<span id="cb1-676"><a href="#cb1-676" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>size <span class="op">=</span> dip<span class="op">.</span>size<span class="op">;</span></span>
<span id="cb1-677"><a href="#cb1-677" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>addrs<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>dip<span class="op">.</span>addrs)<span class="op">;</span></span>
<span id="cb1-678"><a href="#cb1-678" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>valid <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb1-679"><a href="#cb1-679" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>dev <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>dev<span class="op">;</span></span>
<span id="cb1-680"><a href="#cb1-680" aria-hidden="true" tabindex="-1"></a>            guard<span class="op">.</span>inum <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>inum<span class="op">;</span></span>
<span id="cb1-681"><a href="#cb1-681" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Empty <span class="op">{</span></span>
<span id="cb1-682"><a href="#cb1-682" aria-hidden="true" tabindex="-1"></a>                <span class="pp">panic!</span>(<span class="st">&quot;ilock: no type&quot;</span>)<span class="op">;</span></span>
<span id="cb1-683"><a href="#cb1-683" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-684"><a href="#cb1-684" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-685"><a href="#cb1-685" aria-hidden="true" tabindex="-1"></a>        guard</span>
<span id="cb1-686"><a href="#cb1-686" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-687"><a href="#cb1-687" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-688"><a href="#cb1-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-689"><a href="#cb1-689" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-690"><a href="#cb1-690" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Inode <span class="op">{</span></span>
<span id="cb1-691"><a href="#cb1-691" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> new(ip<span class="op">:</span> Arc<span class="op">&lt;</span>MInode<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-692"><a href="#cb1-692" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span> ip<span class="op">:</span> <span class="cn">Some</span>(ip) <span class="op">}</span></span>
<span id="cb1-693"><a href="#cb1-693" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-694"><a href="#cb1-694" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Increments reference count fot Inode.</span></span>
<span id="cb1-695"><a href="#cb1-695" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return cloned Inode to enable ip = ip1.dup() idiom.</span></span>
<span id="cb1-696"><a href="#cb1-696" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> dup(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-697"><a href="#cb1-697" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-698"><a href="#cb1-698" aria-hidden="true" tabindex="-1"></a>            ip<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>ip<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb1-699"><a href="#cb1-699" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-700"><a href="#cb1-700" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-701"><a href="#cb1-701" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> is_some(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-702"><a href="#cb1-702" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ip<span class="op">.</span>is_some()</span>
<span id="cb1-703"><a href="#cb1-703" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-704"><a href="#cb1-704" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> is_none(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-705"><a href="#cb1-705" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ip<span class="op">.</span>is_none()</span>
<span id="cb1-706"><a href="#cb1-706" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-707"><a href="#cb1-707" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-708"><a href="#cb1-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-709"><a href="#cb1-709" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-710"><a href="#cb1-710" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Drop</span> <span class="cf">for</span> Inode <span class="op">{</span></span>
<span id="cb1-711"><a href="#cb1-711" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> drop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb1-712"><a href="#cb1-712" aria-hidden="true" tabindex="-1"></a>        ITABLE<span class="op">.</span>put(<span class="kw">self</span><span class="op">.</span>ip<span class="op">.</span>take()<span class="op">.</span>unwrap())<span class="op">;</span></span>
<span id="cb1-713"><a href="#cb1-713" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-714"><a href="#cb1-714" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-715"><a href="#cb1-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-716"><a href="#cb1-716" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-717"><a href="#cb1-717" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Deref</span> <span class="cf">for</span> Inode <span class="op">{</span></span>
<span id="cb1-718"><a href="#cb1-718" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> Target <span class="op">=</span> MInode<span class="op">;</span></span>
<span id="cb1-719"><a href="#cb1-719" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> deref(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Target <span class="op">{</span></span>
<span id="cb1-720"><a href="#cb1-720" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ref count &gt;2 ?</span></span>
<span id="cb1-721"><a href="#cb1-721" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ip<span class="op">.</span>as_ref()<span class="op">.</span>unwrap()</span>
<span id="cb1-722"><a href="#cb1-722" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-723"><a href="#cb1-723" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-724"><a href="#cb1-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-725"><a href="#cb1-725" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-726"><a href="#cb1-726" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ITable <span class="op">=</span> Mutex<span class="op">&lt;</span>[<span class="dt">Option</span><span class="op">&lt;</span>Arc<span class="op">&lt;</span>MInode<span class="op">&gt;&gt;;</span> NINODE]<span class="op">&gt;;</span></span>
<span id="cb1-727"><a href="#cb1-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-728"><a href="#cb1-728" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-729"><a href="#cb1-729" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> ITable <span class="op">{</span></span>
<span id="cb1-730"><a href="#cb1-730" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate an inode on device dev.</span></span>
<span id="cb1-731"><a href="#cb1-731" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark it as allocated by giving it type.</span></span>
<span id="cb1-732"><a href="#cb1-732" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Returns an unlocked but allocated and referenced inode.</span></span>
<span id="cb1-733"><a href="#cb1-733" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> alloc(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> itype<span class="op">:</span> FileType) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Inode<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-734"><a href="#cb1-734" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> sb <span class="op">=</span> SB<span class="op">.</span>get()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-735"><a href="#cb1-735" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inum <span class="kw">in</span> <span class="dv">1</span><span class="op">..</span>sb<span class="op">.</span>ninodes <span class="op">{</span></span>
<span id="cb1-736"><a href="#cb1-736" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> bp <span class="op">=</span> BCACHE<span class="op">.</span>read(dev<span class="op">,</span> sb<span class="op">.</span>iblock(inum))<span class="op">;</span></span>
<span id="cb1-737"><a href="#cb1-737" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> dip <span class="op">=</span> bp</span>
<span id="cb1-738"><a href="#cb1-738" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">align_to_mut::</span><span class="op">&lt;</span>DInode<span class="op">&gt;</span>()</span>
<span id="cb1-739"><a href="#cb1-739" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>get_mut(inum <span class="kw">as</span> <span class="dt">usize</span> <span class="op">%</span> IPB)</span>
<span id="cb1-740"><a href="#cb1-740" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-741"><a href="#cb1-741" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> dip<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Empty <span class="op">{</span></span>
<span id="cb1-742"><a href="#cb1-742" aria-hidden="true" tabindex="-1"></a>                <span class="co">// a free inode</span></span>
<span id="cb1-743"><a href="#cb1-743" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span>dip <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb1-744"><a href="#cb1-744" aria-hidden="true" tabindex="-1"></a>                dip<span class="op">.</span>itype <span class="op">=</span> itype<span class="op">;</span></span>
<span id="cb1-745"><a href="#cb1-745" aria-hidden="true" tabindex="-1"></a>                LOG<span class="op">.</span>write(bp)<span class="op">;</span></span>
<span id="cb1-746"><a href="#cb1-746" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">self</span><span class="op">.</span>get(dev<span class="op">,</span> inum)<span class="op">;</span></span>
<span id="cb1-747"><a href="#cb1-747" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-748"><a href="#cb1-748" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-749"><a href="#cb1-749" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(StorageFull) <span class="co">// no inodes</span></span>
<span id="cb1-750"><a href="#cb1-750" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-751"><a href="#cb1-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-752"><a href="#cb1-752" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find the inode with number inum on device dev</span></span>
<span id="cb1-753"><a href="#cb1-753" aria-hidden="true" tabindex="-1"></a>    <span class="co">// and return the in-memoroy copy. Does not lock</span></span>
<span id="cb1-754"><a href="#cb1-754" aria-hidden="true" tabindex="-1"></a>    <span class="co">// the inode and does not read it from disk.</span></span>
<span id="cb1-755"><a href="#cb1-755" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> dev<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> inum<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Inode<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-756"><a href="#cb1-756" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> guard <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-757"><a href="#cb1-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-758"><a href="#cb1-758" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Is the inode already in the table?</span></span>
<span id="cb1-759"><a href="#cb1-759" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> empty<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;&amp;</span><span class="kw">mut</span> <span class="dt">Option</span><span class="op">&lt;</span>Arc<span class="op">&lt;</span>MInode<span class="op">&gt;&gt;&gt;</span> <span class="op">=</span> <span class="cn">None</span><span class="op">;</span></span>
<span id="cb1-760"><a href="#cb1-760" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ip <span class="kw">in</span> guard<span class="op">.</span>iter_mut() <span class="op">{</span></span>
<span id="cb1-761"><a href="#cb1-761" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> ip <span class="op">{</span></span>
<span id="cb1-762"><a href="#cb1-762" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Some</span>(ip) <span class="cf">if</span> ip<span class="op">.</span>dev <span class="op">==</span> dev <span class="op">&amp;&amp;</span> ip<span class="op">.</span>inum <span class="op">==</span> inum <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-763"><a href="#cb1-763" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="cn">Ok</span>(<span class="pp">Inode::</span>new(<span class="pp">Arc::</span>clone(ip)))<span class="op">;</span></span>
<span id="cb1-764"><a href="#cb1-764" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-765"><a href="#cb1-765" aria-hidden="true" tabindex="-1"></a>                <span class="cn">None</span> <span class="cf">if</span> empty<span class="op">.</span>is_none() <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-766"><a href="#cb1-766" aria-hidden="true" tabindex="-1"></a>                    empty <span class="op">=</span> <span class="cn">Some</span>(ip)<span class="op">;</span></span>
<span id="cb1-767"><a href="#cb1-767" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-768"><a href="#cb1-768" aria-hidden="true" tabindex="-1"></a>                _ <span class="op">=&gt;</span> ()<span class="op">,</span></span>
<span id="cb1-769"><a href="#cb1-769" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-770"><a href="#cb1-770" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-771"><a href="#cb1-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-772"><a href="#cb1-772" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Recycle an inode entry</span></span>
<span id="cb1-773"><a href="#cb1-773" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> empty <span class="op">=</span> <span class="cf">match</span> empty <span class="op">{</span></span>
<span id="cb1-774"><a href="#cb1-774" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(ip) <span class="op">=&gt;</span> ip<span class="op">,</span></span>
<span id="cb1-775"><a href="#cb1-775" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span> <span class="op">=&gt;</span> <span class="cf">return</span> <span class="cn">Err</span>(FileTableOverflow)<span class="op">,</span></span>
<span id="cb1-776"><a href="#cb1-776" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb1-777"><a href="#cb1-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-778"><a href="#cb1-778" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ip <span class="op">=</span> <span class="pp">Arc::</span>new(<span class="pp">MInode::</span>new(dev<span class="op">,</span> inum))<span class="op">;</span></span>
<span id="cb1-779"><a href="#cb1-779" aria-hidden="true" tabindex="-1"></a>        empty<span class="op">.</span>replace(<span class="pp">Arc::</span>clone(<span class="op">&amp;</span>ip))<span class="op">;</span></span>
<span id="cb1-780"><a href="#cb1-780" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="pp">Inode::</span>new(ip))</span>
<span id="cb1-781"><a href="#cb1-781" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-782"><a href="#cb1-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-783"><a href="#cb1-783" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Drop a reference to an in-memory inode.</span></span>
<span id="cb1-784"><a href="#cb1-784" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If that was the last reference, the inode table entry can</span></span>
<span id="cb1-785"><a href="#cb1-785" aria-hidden="true" tabindex="-1"></a>    <span class="co">// be recycled.</span></span>
<span id="cb1-786"><a href="#cb1-786" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If that was the last reference and the inode has no links</span></span>
<span id="cb1-787"><a href="#cb1-787" aria-hidden="true" tabindex="-1"></a>    <span class="co">// to it, free the inode (and its content) on disk.</span></span>
<span id="cb1-788"><a href="#cb1-788" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All calls to put() must be inside a transaction in</span></span>
<span id="cb1-789"><a href="#cb1-789" aria-hidden="true" tabindex="-1"></a>    <span class="co">// case it has to free the inode.</span></span>
<span id="cb1-790"><a href="#cb1-790" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> put(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> inode<span class="op">:</span> Arc<span class="op">&lt;</span>MInode<span class="op">&gt;</span>) <span class="op">{</span></span>
<span id="cb1-791"><a href="#cb1-791" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> guard <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-792"><a href="#cb1-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-793"><a href="#cb1-793" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="pp">Arc::</span>strong_count(<span class="op">&amp;</span>inode) <span class="op">==</span> <span class="dv">2</span> <span class="op">{</span></span>
<span id="cb1-794"><a href="#cb1-794" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Arc::strong_count(inode) == 2 means no other process can have inode sleeplocked,</span></span>
<span id="cb1-795"><a href="#cb1-795" aria-hidden="true" tabindex="-1"></a>            <span class="co">// so this sleeplock won&#39;t block (or dead lock).</span></span>
<span id="cb1-796"><a href="#cb1-796" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> idata <span class="op">=</span> inode<span class="op">.</span>data<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-797"><a href="#cb1-797" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> itable <span class="op">=</span> <span class="pp">Mutex::</span>unlock(guard)<span class="op">;</span></span>
<span id="cb1-798"><a href="#cb1-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-799"><a href="#cb1-799" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> idata<span class="op">.</span>valid <span class="op">&amp;&amp;</span> idata<span class="op">.</span>nlink <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-800"><a href="#cb1-800" aria-hidden="true" tabindex="-1"></a>                <span class="co">// inode has no links and no other references: truncate and free.</span></span>
<span id="cb1-801"><a href="#cb1-801" aria-hidden="true" tabindex="-1"></a>                idata<span class="op">.</span>trunc()<span class="op">;</span></span>
<span id="cb1-802"><a href="#cb1-802" aria-hidden="true" tabindex="-1"></a>                idata<span class="op">.</span>set_type(<span class="pp">FileType::</span>Empty)<span class="op">;</span></span>
<span id="cb1-803"><a href="#cb1-803" aria-hidden="true" tabindex="-1"></a>                idata<span class="op">.</span>valid <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb1-804"><a href="#cb1-804" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-805"><a href="#cb1-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-806"><a href="#cb1-806" aria-hidden="true" tabindex="-1"></a>            guard <span class="op">=</span> itable<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-807"><a href="#cb1-807" aria-hidden="true" tabindex="-1"></a>            <span class="co">// drop in-memory inode.</span></span>
<span id="cb1-808"><a href="#cb1-808" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> mip <span class="kw">in</span> guard<span class="op">.</span>iter_mut() <span class="op">{</span></span>
<span id="cb1-809"><a href="#cb1-809" aria-hidden="true" tabindex="-1"></a>                <span class="cf">match</span> mip <span class="op">{</span></span>
<span id="cb1-810"><a href="#cb1-810" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">Some</span>(ip) <span class="cf">if</span> <span class="pp">Arc::</span>ptr_eq(<span class="op">&amp;</span>inode<span class="op">,</span> ip) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-811"><a href="#cb1-811" aria-hidden="true" tabindex="-1"></a>                        mip<span class="op">.</span>take()<span class="op">;</span></span>
<span id="cb1-812"><a href="#cb1-812" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb1-813"><a href="#cb1-813" aria-hidden="true" tabindex="-1"></a>                    _ <span class="op">=&gt;</span> ()<span class="op">,</span></span>
<span id="cb1-814"><a href="#cb1-814" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-815"><a href="#cb1-815" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-816"><a href="#cb1-816" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-817"><a href="#cb1-817" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-818"><a href="#cb1-818" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-819"><a href="#cb1-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-820"><a href="#cb1-820" aria-hidden="true" tabindex="-1"></a><span class="co">// Create the path new as a link to the same inode as old.</span></span>
<span id="cb1-821"><a href="#cb1-821" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-822"><a href="#cb1-822" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> link(old<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span><span class="op">,</span> new<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-823"><a href="#cb1-823" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (_<span class="op">,</span> ip) <span class="op">=</span> old<span class="op">.</span>namei()<span class="op">?;</span></span>
<span id="cb1-824"><a href="#cb1-824" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-825"><a href="#cb1-825" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ip_guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-826"><a href="#cb1-826" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ip_guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-827"><a href="#cb1-827" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(IsADirectory)<span class="op">;</span></span>
<span id="cb1-828"><a href="#cb1-828" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-829"><a href="#cb1-829" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-830"><a href="#cb1-830" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ?</span></span>
<span id="cb1-831"><a href="#cb1-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-832"><a href="#cb1-832" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (name<span class="op">,</span> dp) <span class="op">=</span> new<span class="op">.</span>nameiparent()<span class="op">?;</span></span>
<span id="cb1-833"><a href="#cb1-833" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> dp_guard <span class="op">=</span> dp<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-834"><a href="#cb1-834" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dp<span class="op">.</span>dev <span class="op">!=</span> ip<span class="op">.</span>dev <span class="op">{</span></span>
<span id="cb1-835"><a href="#cb1-835" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(CrossesDevices)<span class="op">;</span></span>
<span id="cb1-836"><a href="#cb1-836" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-837"><a href="#cb1-837" aria-hidden="true" tabindex="-1"></a>    dp_guard<span class="op">.</span>dirlink(name<span class="op">,</span> ip<span class="op">.</span>inum)<span class="op">?;</span></span>
<span id="cb1-838"><a href="#cb1-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-839"><a href="#cb1-839" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-840"><a href="#cb1-840" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> ip_guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-841"><a href="#cb1-841" aria-hidden="true" tabindex="-1"></a>        ip_guard<span class="op">.</span>nlink <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-842"><a href="#cb1-842" aria-hidden="true" tabindex="-1"></a>        ip_guard<span class="op">.</span>update()<span class="op">;</span></span>
<span id="cb1-843"><a href="#cb1-843" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-844"><a href="#cb1-844" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb1-845"><a href="#cb1-845" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-846"><a href="#cb1-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-847"><a href="#cb1-847" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-848"><a href="#cb1-848" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> unlink(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-849"><a href="#cb1-849" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> de<span class="op">:</span> DirEnt <span class="op">=</span> <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb1-850"><a href="#cb1-850" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> off<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-851"><a href="#cb1-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-852"><a href="#cb1-852" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (name<span class="op">,</span> dp) <span class="op">=</span> path<span class="op">.</span>nameiparent()<span class="op">?;</span></span>
<span id="cb1-853"><a href="#cb1-853" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> dp_guard <span class="op">=</span> dp<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-854"><a href="#cb1-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-855"><a href="#cb1-855" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cannot unlink &quot;.&quot; or &quot;..&quot;</span></span>
<span id="cb1-856"><a href="#cb1-856" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name <span class="op">==</span> <span class="st">&quot;.&quot;</span> <span class="op">||</span> name <span class="op">==</span> <span class="st">&quot;..&quot;</span> <span class="op">{</span></span>
<span id="cb1-857"><a href="#cb1-857" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(PermissionDenied)<span class="op">;</span></span>
<span id="cb1-858"><a href="#cb1-858" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-859"><a href="#cb1-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-860"><a href="#cb1-860" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ip <span class="op">=</span> dp_guard<span class="op">.</span>dirlookup(name<span class="op">,</span> <span class="cn">Some</span>(<span class="op">&amp;</span><span class="kw">mut</span> off))<span class="op">?;</span></span>
<span id="cb1-861"><a href="#cb1-861" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> ip_guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-862"><a href="#cb1-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-863"><a href="#cb1-863" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ip_guard<span class="op">.</span>nlink <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">{</span></span>
<span id="cb1-864"><a href="#cb1-864" aria-hidden="true" tabindex="-1"></a>        <span class="pp">panic!</span>(<span class="st">&quot;unlink: nlink &lt; 1&quot;</span>)<span class="op">;</span></span>
<span id="cb1-865"><a href="#cb1-865" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-866"><a href="#cb1-866" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ip_guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Dir <span class="op">&amp;&amp;</span> <span class="op">!</span>ip_guard<span class="op">.</span>is_dir_empty() <span class="op">{</span></span>
<span id="cb1-867"><a href="#cb1-867" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(DirectoryNotEmpty)<span class="op">;</span></span>
<span id="cb1-868"><a href="#cb1-868" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-869"><a href="#cb1-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-870"><a href="#cb1-870" aria-hidden="true" tabindex="-1"></a>    dp_guard<span class="op">.</span>write(</span>
<span id="cb1-871"><a href="#cb1-871" aria-hidden="true" tabindex="-1"></a>        <span class="pp">VirtAddr::</span>Kernel(<span class="op">&amp;</span>de <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> _ <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">,</span></span>
<span id="cb1-872"><a href="#cb1-872" aria-hidden="true" tabindex="-1"></a>        off<span class="op">,</span></span>
<span id="cb1-873"><a href="#cb1-873" aria-hidden="true" tabindex="-1"></a>        <span class="pp">size_of::</span><span class="op">&lt;</span>DirEnt<span class="op">&gt;</span>()<span class="op">,</span></span>
<span id="cb1-874"><a href="#cb1-874" aria-hidden="true" tabindex="-1"></a>    )<span class="op">?;</span></span>
<span id="cb1-875"><a href="#cb1-875" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ip_guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-876"><a href="#cb1-876" aria-hidden="true" tabindex="-1"></a>        dp_guard<span class="op">.</span>set_nlink(<span class="pp">LinkOp::</span>Minus)<span class="op">;</span></span>
<span id="cb1-877"><a href="#cb1-877" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-878"><a href="#cb1-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-879"><a href="#cb1-879" aria-hidden="true" tabindex="-1"></a>    ip_guard<span class="op">.</span>set_nlink(<span class="pp">LinkOp::</span>Minus)<span class="op">;</span></span>
<span id="cb1-880"><a href="#cb1-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-881"><a href="#cb1-881" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb1-882"><a href="#cb1-882" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-883"><a href="#cb1-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-884"><a href="#cb1-884" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-885"><a href="#cb1-885" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> create(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span><span class="op">,</span> type_<span class="op">:</span> FileType<span class="op">,</span> major<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span> minor<span class="op">:</span> <span class="dt">u16</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Inode<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-886"><a href="#cb1-886" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (name<span class="op">,</span> dp) <span class="op">=</span> path<span class="op">.</span>nameiparent()<span class="op">?;</span></span>
<span id="cb1-887"><a href="#cb1-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-888"><a href="#cb1-888" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ip<span class="op">:</span> Inode<span class="op">;</span></span>
<span id="cb1-889"><a href="#cb1-889" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-890"><a href="#cb1-890" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> dp_guard <span class="op">=</span> dp<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-891"><a href="#cb1-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-892"><a href="#cb1-892" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Ok</span>(ip) <span class="op">=</span> dp_guard<span class="op">.</span>dirlookup(name<span class="op">,</span> <span class="cn">None</span>) <span class="op">{</span></span>
<span id="cb1-893"><a href="#cb1-893" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SleepLock::</span>unlock(dp_guard)<span class="op">;</span></span>
<span id="cb1-894"><a href="#cb1-894" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> ip_guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-895"><a href="#cb1-895" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> type_ <span class="op">{</span></span>
<span id="cb1-896"><a href="#cb1-896" aria-hidden="true" tabindex="-1"></a>                <span class="pp">FileType::</span>File</span>
<span id="cb1-897"><a href="#cb1-897" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> ip_guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>File <span class="op">||</span> ip_guard<span class="op">.</span>itype <span class="op">==</span> <span class="pp">FileType::</span>Device <span class="op">=&gt;</span></span>
<span id="cb1-898"><a href="#cb1-898" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb1-899"><a href="#cb1-899" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">SleepLock::</span>unlock(ip_guard)<span class="op">;</span></span>
<span id="cb1-900"><a href="#cb1-900" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="cn">Ok</span>(ip)<span class="op">;</span></span>
<span id="cb1-901"><a href="#cb1-901" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-902"><a href="#cb1-902" aria-hidden="true" tabindex="-1"></a>                _ <span class="op">=&gt;</span> <span class="cf">return</span> <span class="cn">Err</span>(AlreadyExists)<span class="op">,</span></span>
<span id="cb1-903"><a href="#cb1-903" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-904"><a href="#cb1-904" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-905"><a href="#cb1-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-906"><a href="#cb1-906" aria-hidden="true" tabindex="-1"></a>        ip <span class="op">=</span> ITABLE<span class="op">.</span>alloc(dp<span class="op">.</span>dev<span class="op">,</span> type_)<span class="op">?;</span></span>
<span id="cb1-907"><a href="#cb1-907" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> ip_guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-908"><a href="#cb1-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-909"><a href="#cb1-909" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> type_ <span class="op">==</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-910"><a href="#cb1-910" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create . and .. entries.</span></span>
<span id="cb1-911"><a href="#cb1-911" aria-hidden="true" tabindex="-1"></a>            <span class="co">// No ip-&gt;nlink++ for &quot;.&quot;: avoid cyclic ref count.</span></span>
<span id="cb1-912"><a href="#cb1-912" aria-hidden="true" tabindex="-1"></a>            ip_guard<span class="op">.</span>dirlink(<span class="st">&quot;.&quot;</span><span class="op">,</span> ip<span class="op">.</span>inum)<span class="op">?;</span></span>
<span id="cb1-913"><a href="#cb1-913" aria-hidden="true" tabindex="-1"></a>            ip_guard<span class="op">.</span>dirlink(<span class="st">&quot;..&quot;</span><span class="op">,</span> dp<span class="op">.</span>inum)<span class="op">?;</span></span>
<span id="cb1-914"><a href="#cb1-914" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-915"><a href="#cb1-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-916"><a href="#cb1-916" aria-hidden="true" tabindex="-1"></a>        dp_guard<span class="op">.</span>dirlink(name<span class="op">,</span> ip<span class="op">.</span>inum)<span class="op">?;</span></span>
<span id="cb1-917"><a href="#cb1-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-918"><a href="#cb1-918" aria-hidden="true" tabindex="-1"></a>        <span class="co">// now that success is guaranteed</span></span>
<span id="cb1-919"><a href="#cb1-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-920"><a href="#cb1-920" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> type_ <span class="op">==</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-921"><a href="#cb1-921" aria-hidden="true" tabindex="-1"></a>            dp_guard<span class="op">.</span>set_nlink(<span class="pp">LinkOp::</span>Plus)<span class="op">;</span> <span class="co">// for &quot;..&quot;</span></span>
<span id="cb1-922"><a href="#cb1-922" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-923"><a href="#cb1-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-924"><a href="#cb1-924" aria-hidden="true" tabindex="-1"></a>        ip_guard<span class="op">.</span>set_major_minor(<span class="pp">Major::</span>from_u16(major)<span class="op">,</span> minor)<span class="op">;</span></span>
<span id="cb1-925"><a href="#cb1-925" aria-hidden="true" tabindex="-1"></a>        ip_guard<span class="op">.</span>set_nlink(<span class="pp">LinkOp::</span>Init(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb1-926"><a href="#cb1-926" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-927"><a href="#cb1-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-928"><a href="#cb1-928" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(ip)</span>
<span id="cb1-929"><a href="#cb1-929" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-930"><a href="#cb1-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-931"><a href="#cb1-931" aria-hidden="true" tabindex="-1"></a><span class="co">// Paths</span></span>
<span id="cb1-932"><a href="#cb1-932" aria-hidden="true" tabindex="-1"></a><span class="co">// A slice of a path (akin to str)</span></span>
<span id="cb1-933"><a href="#cb1-933" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-934"><a href="#cb1-934" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb1-935"><a href="#cb1-935" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></span>
<span id="cb1-936"><a href="#cb1-936" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> <span class="dt">Path</span> <span class="op">{</span></span>
<span id="cb1-937"><a href="#cb1-937" aria-hidden="true" tabindex="-1"></a>    inner<span class="op">:</span> <span class="dt">str</span><span class="op">,</span></span>
<span id="cb1-938"><a href="#cb1-938" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-939"><a href="#cb1-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-940"><a href="#cb1-940" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-941"><a href="#cb1-941" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">AsRef</span><span class="op">&lt;</span><span class="dt">Path</span><span class="op">&gt;</span> <span class="cf">for</span> <span class="dt">str</span> <span class="op">{</span></span>
<span id="cb1-942"><a href="#cb1-942" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> as_ref(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="dt">Path</span> <span class="op">{</span></span>
<span id="cb1-943"><a href="#cb1-943" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Path</span><span class="pp">::</span>new(<span class="kw">self</span>)</span>
<span id="cb1-944"><a href="#cb1-944" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-945"><a href="#cb1-945" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-946"><a href="#cb1-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-947"><a href="#cb1-947" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>target_os <span class="op">=</span> <span class="st">&quot;none&quot;</span><span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;kernel&quot;</span><span class="at">))]</span></span>
<span id="cb1-948"><a href="#cb1-948" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="dt">Path</span> <span class="op">{</span></span>
<span id="cb1-949"><a href="#cb1-949" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new<span class="op">&lt;</span>S<span class="op">:</span> <span class="bu">AsRef</span><span class="op">&lt;</span><span class="dt">str</span><span class="op">&gt;</span> <span class="op">+</span> <span class="op">?</span><span class="bu">Sized</span><span class="op">&gt;</span>(s<span class="op">:</span> <span class="op">&amp;</span>S) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="dt">Path</span> <span class="op">{</span></span>
<span id="cb1-950"><a href="#cb1-950" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span> <span class="op">&amp;*</span>(s<span class="op">.</span>as_ref() <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">str</span> <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">Path</span>) <span class="op">}</span></span>
<span id="cb1-951"><a href="#cb1-951" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-952"><a href="#cb1-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-953"><a href="#cb1-953" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> file_name(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;&amp;</span><span class="dt">str</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-954"><a href="#cb1-954" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>ends_with(<span class="st">&quot;..&quot;</span>) <span class="op">{</span></span>
<span id="cb1-955"><a href="#cb1-955" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">None</span><span class="op">;</span></span>
<span id="cb1-956"><a href="#cb1-956" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-957"><a href="#cb1-957" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>rsplit_once(<span class="ch">&#39;/&#39;</span>) <span class="op">{</span></span>
<span id="cb1-958"><a href="#cb1-958" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>((_<span class="op">,</span> file_name)) <span class="op">=&gt;</span> <span class="cn">Some</span>(file_name)<span class="op">,</span></span>
<span id="cb1-959"><a href="#cb1-959" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>inner)<span class="op">,</span></span>
<span id="cb1-960"><a href="#cb1-960" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-961"><a href="#cb1-961" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-962"><a href="#cb1-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-963"><a href="#cb1-963" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get next path element from path as name &amp;str,</span></span>
<span id="cb1-964"><a href="#cb1-964" aria-hidden="true" tabindex="-1"></a>    <span class="co">// the element following the name as &amp;Path</span></span>
<span id="cb1-965"><a href="#cb1-965" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb1-966"><a href="#cb1-966" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Examples:</span></span>
<span id="cb1-967"><a href="#cb1-967" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   skip_elem(&quot;a/bb/c&quot;) = (Some(&quot;a&quot;), Some(&quot;bb/c&quot;)),</span></span>
<span id="cb1-968"><a href="#cb1-968" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   skip_elem(&quot;///a//bb&quot;) = (Some(&quot;a&quot;), Some(&quot;/bb&quot;)),</span></span>
<span id="cb1-969"><a href="#cb1-969" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   skipelem(&quot;a&quot;) = (Some(&quot;a&quot;), None)</span></span>
<span id="cb1-970"><a href="#cb1-970" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   skipelem(&quot;&quot;) = skipelem(&quot;////&quot;) = (None, None)</span></span>
<span id="cb1-971"><a href="#cb1-971" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   if name: &amp;str &gt; DIRSIZE return (None, None)</span></span>
<span id="cb1-972"><a href="#cb1-972" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> skip_elem(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> (<span class="dt">Option</span><span class="op">&lt;&amp;</span><span class="dt">str</span><span class="op">&gt;,</span> <span class="dt">Option</span><span class="op">&lt;&amp;</span><span class="dt">Path</span><span class="op">&gt;</span>) <span class="op">{</span></span>
<span id="cb1-973"><a href="#cb1-973" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>trim_matches(<span class="ch">&#39;/&#39;</span>)<span class="op">.</span>split_once(<span class="ch">&#39;/&#39;</span>) <span class="op">{</span></span>
<span id="cb1-974"><a href="#cb1-974" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>((name<span class="op">,</span> path)) <span class="cf">if</span> name<span class="op">.</span>len() <span class="op">&lt;=</span> DIRSIZ <span class="op">=&gt;</span> (<span class="cn">Some</span>(name)<span class="op">,</span> <span class="cn">Some</span>(<span class="dt">Path</span><span class="pp">::</span>new(path)))<span class="op">,</span></span>
<span id="cb1-975"><a href="#cb1-975" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span> <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>trim_matches(<span class="ch">&#39;/&#39;</span>)<span class="op">.</span>is_empty()</span>
<span id="cb1-976"><a href="#cb1-976" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> <span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>trim_matches(<span class="ch">&#39;/&#39;</span>)<span class="op">.</span>len() <span class="op">&lt;</span> DIRSIZ <span class="op">=&gt;</span></span>
<span id="cb1-977"><a href="#cb1-977" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb1-978"><a href="#cb1-978" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>inner<span class="op">.</span>trim_matches(<span class="ch">&#39;/&#39;</span>))<span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb1-979"><a href="#cb1-979" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-980"><a href="#cb1-980" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> (<span class="cn">None</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">,</span></span>
<span id="cb1-981"><a href="#cb1-981" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-982"><a href="#cb1-982" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-983"><a href="#cb1-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-984"><a href="#cb1-984" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Look up and return the inode for a path name.</span></span>
<span id="cb1-985"><a href="#cb1-985" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If `parent` is true, return the inode for the parent.</span></span>
<span id="cb1-986"><a href="#cb1-986" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Must be called inside a transaction since it calls ITABLE.put()</span></span>
<span id="cb1-987"><a href="#cb1-987" aria-hidden="true" tabindex="-1"></a>    <span class="co">// when dropping an inode.</span></span>
<span id="cb1-988"><a href="#cb1-988" aria-hidden="true" tabindex="-1"></a>    <span class="co">// # Safety:</span></span>
<span id="cb1-989"><a href="#cb1-989" aria-hidden="true" tabindex="-1"></a>    <span class="co">// call inside a transaction.</span></span>
<span id="cb1-990"><a href="#cb1-990" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> namex(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span><span class="op">,</span> parent<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>(<span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> Inode)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-991"><a href="#cb1-991" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> ip <span class="op">=</span> <span class="cf">match</span> path<span class="op">.</span>inner<span class="op">.</span>get(<span class="dv">0</span><span class="op">..</span><span class="dv">1</span>) <span class="op">{</span></span>
<span id="cb1-992"><a href="#cb1-992" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="st">&quot;/&quot;</span>) <span class="op">=&gt;</span> ITABLE<span class="op">.</span>get(ROOTDEV<span class="op">,</span> ROOTINO)<span class="op">?,</span></span>
<span id="cb1-993"><a href="#cb1-993" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="pp">Cpus::</span>myproc()<span class="op">.</span>unwrap()<span class="op">.</span>data()<span class="op">.</span>cwd<span class="op">.</span>as_ref()<span class="op">.</span>unwrap()<span class="op">.</span>dup()<span class="op">,</span></span>
<span id="cb1-994"><a href="#cb1-994" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb1-995"><a href="#cb1-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-996"><a href="#cb1-996" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> path <span class="op">=</span> path<span class="op">;</span></span>
<span id="cb1-997"><a href="#cb1-997" aria-hidden="true" tabindex="-1"></a>        <span class="cf">loop</span> <span class="op">{</span></span>
<span id="cb1-998"><a href="#cb1-998" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> guard <span class="op">=</span> ip<span class="op">.</span>lock()<span class="op">;</span></span>
<span id="cb1-999"><a href="#cb1-999" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> guard<span class="op">.</span>itype <span class="op">!=</span> <span class="pp">FileType::</span>Dir <span class="op">{</span></span>
<span id="cb1-1000"><a href="#cb1-1000" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(NotADirectory)<span class="op">;</span></span>
<span id="cb1-1001"><a href="#cb1-1001" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-1002"><a href="#cb1-1002" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> path<span class="op">.</span>skip_elem() <span class="op">{</span></span>
<span id="cb1-1003"><a href="#cb1-1003" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">Some</span>(name)<span class="op">,</span> <span class="cn">Some</span>(npath)) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-1004"><a href="#cb1-1004" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> nip <span class="op">=</span> guard<span class="op">.</span>dirlookup(name<span class="op">,</span> <span class="cn">None</span>)<span class="op">?;</span></span>
<span id="cb1-1005"><a href="#cb1-1005" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">SleepLock::</span>unlock(guard)<span class="op">;</span></span>
<span id="cb1-1006"><a href="#cb1-1006" aria-hidden="true" tabindex="-1"></a>                    ip <span class="op">=</span> nip<span class="op">;</span></span>
<span id="cb1-1007"><a href="#cb1-1007" aria-hidden="true" tabindex="-1"></a>                    path <span class="op">=</span> npath<span class="op">;</span></span>
<span id="cb1-1008"><a href="#cb1-1008" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb1-1009"><a href="#cb1-1009" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-1010"><a href="#cb1-1010" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">Some</span>(name)<span class="op">,</span> <span class="cn">None</span>) <span class="cf">if</span> <span class="op">!</span>parent <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-1011"><a href="#cb1-1011" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> ip <span class="op">=</span> guard<span class="op">.</span>dirlookup(name<span class="op">,</span> <span class="cn">None</span>)<span class="op">?;</span></span>
<span id="cb1-1012"><a href="#cb1-1012" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">SleepLock::</span>unlock(guard)<span class="op">;</span></span>
<span id="cb1-1013"><a href="#cb1-1013" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span> <span class="cn">Ok</span>((name<span class="op">,</span> ip))<span class="op">;</span></span>
<span id="cb1-1014"><a href="#cb1-1014" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-1015"><a href="#cb1-1015" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">Some</span>(name)<span class="op">,</span> <span class="cn">None</span>) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-1016"><a href="#cb1-1016" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">SleepLock::</span>unlock(guard)<span class="op">;</span></span>
<span id="cb1-1017"><a href="#cb1-1017" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span> <span class="cn">Ok</span>((name<span class="op">,</span> ip))<span class="op">;</span></span>
<span id="cb1-1018"><a href="#cb1-1018" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-1019"><a href="#cb1-1019" aria-hidden="true" tabindex="-1"></a>                _ <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb1-1020"><a href="#cb1-1020" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(<span class="st">&quot;/&quot;</span>) <span class="op">=</span> path<span class="op">.</span>inner<span class="op">.</span>get(<span class="op">..</span>) <span class="op">{</span></span>
<span id="cb1-1021"><a href="#cb1-1021" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">SleepLock::</span>unlock(guard)<span class="op">;</span></span>
<span id="cb1-1022"><a href="#cb1-1022" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span> <span class="cn">Ok</span>((<span class="st">&quot;/&quot;</span><span class="op">,</span> ip))<span class="op">;</span></span>
<span id="cb1-1023"><a href="#cb1-1023" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-1024"><a href="#cb1-1024" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span> <span class="cn">Err</span>(NotFound)<span class="op">;</span></span>
<span id="cb1-1025"><a href="#cb1-1025" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb1-1026"><a href="#cb1-1026" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-1027"><a href="#cb1-1027" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-1028"><a href="#cb1-1028" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-1029"><a href="#cb1-1029" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-1030"><a href="#cb1-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-1031"><a href="#cb1-1031" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> namei(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>(<span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> Inode)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-1032"><a href="#cb1-1032" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span><span class="pp">::</span>namex(<span class="kw">self</span><span class="op">,</span> <span class="cn">false</span>)</span>
<span id="cb1-1033"><a href="#cb1-1033" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-1034"><a href="#cb1-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-1035"><a href="#cb1-1035" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> nameiparent(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>(<span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> Inode)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-1036"><a href="#cb1-1036" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span><span class="pp">::</span>namex(<span class="kw">self</span><span class="op">,</span> <span class="cn">true</span>)</span>
<span id="cb1-1037"><a href="#cb1-1037" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-1038"><a href="#cb1-1038" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</article>
<script>window.MathJax = { tex: {inlineMath: [["$", "$"], ["\\(", "\\)"]]} }</script>
</body>
</html>
